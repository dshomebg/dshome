'use client';

import { useState, FormEvent } from 'react';
import { useRouter } from 'next/navigation';
import Link from 'next/link';

interface CategoryFormProps {
  initialData?: {
    id: number;
    name: string;
    slug: string;
  };
  isEdit?: boolean;
}

export default function CategoryForm({ initialData, isEdit = false }: CategoryFormProps) {
  const router = useRouter();
  const [formData, setFormData] = useState({
    name: initialData?.name || '',
    slug: initialData?.slug || '',
  });
  const [isSubmitting, setIsSubmitting] = useState(false);
  const [error, setError] = useState<string | null>(null);

  // Транслитерация от кирилица към латиница (българска)
  const transliterate = (text: string): string => {
    const cyrillicToLatin: { [key: string]: string } = {
      'а': 'a', 'б': 'b', 'в': 'v', 'г': 'g', 'д': 'd', 'е': 'e', 'ж': 'zh',
      'з': 'z', 'и': 'i', 'й': 'y', 'к': 'k', 'л': 'l', 'м': 'm', 'н': 'n',
      'о': 'o', 'п': 'p', 'р': 'r', 'с': 's', 'т': 't', 'у': 'u', 'ф': 'f',
      'х': 'h', 'ц': 'ts', 'ч': 'ch', 'ш': 'sh', 'щ': 'sht', 'ъ': 'a', 'ь': 'y',
      'ю': 'yu', 'я': 'ya',
      'А': 'A', 'Б': 'B', 'В': 'V', 'Г': 'G', 'Д': 'D', 'Е': 'E', 'Ж': 'Zh',
      'З': 'Z', 'И': 'I', 'Й': 'Y', 'К': 'K', 'Л': 'L', 'М': 'M', 'Н': 'N',
      'О': 'O', 'П': 'P', 'Р': 'R', 'С': 'S', 'Т': 'T', 'У': 'U', 'Ф': 'F',
      'Х': 'H', 'Ц': 'Ts', 'Ч': 'Ch', 'Ш': 'Sh', 'Щ': 'Sht', 'Ъ': 'A', 'Ь': 'Y',
      'Ю': 'Yu', 'Я': 'Ya'
    };

    return text
      .split('')
      .map(char => cyrillicToLatin[char] || char)
      .join('');
  };

  const generateSlug = (name: string) => {
    return transliterate(name)
      .toLowerCase()
      .trim()
      .replace(/\s+/g, '-')           // Замени интервали с тире
      .replace(/[^\w\-]+/g, '')       // Премахни всички символи освен букви, цифри и тире
      .replace(/\-\-+/g, '-')         // Замени множество тирета с едно
      .replace(/^-+/, '')             // Премахни тирета в начало
      .replace(/-+$/, '');            // Премахни тирета в край
  };

  const handleNameChange = (name: string) => {
    setFormData({
      name,
      slug: generateSlug(name),
    });
  };

  const handleSubmit = async (e: FormEvent<HTMLFormElement>) => {
    e.preventDefault();
    setError(null);
    setIsSubmitting(true);

    try {
      const url = isEdit
        ? `/api/categories/${initialData?.id}`
        : '/api/categories';
      const method = isEdit ? 'PUT' : 'POST';

      const response = await fetch(url, {
        method,
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(formData),
      });

      if (!response.ok) {
        const errorData = await response.json();
        throw new Error(errorData.error || 'Грешка при запазване');
      }

      router.push('/admin/categories');
      router.refresh();
    } catch (err) {
      setError(err instanceof Error ? err.message : 'Грешка при запазване на категория');
    } finally {
      setIsSubmitting(false);
    }
  };

  return (
    <div className="rounded-sm border border-stroke bg-white shadow-default dark:border-strokedark dark:bg-boxdark">
      <div className="border-b border-stroke py-4 px-6.5 dark:border-strokedark">
        <h3 className="font-medium text-black dark:text-white">
          {isEdit ? 'Редактиране на категория' : 'Добавяне на нова категория'}
        </h3>
      </div>

      <form onSubmit={handleSubmit}>
        <div className="p-6.5">
          {error && (
            <div className="mb-4 rounded-lg bg-danger bg-opacity-10 px-4 py-3 text-danger">
              {error}
            </div>
          )}

          <div className="mb-4.5">
            <label className="mb-2.5 block text-black dark:text-white">
              Име на категория <span className="text-meta-1">*</span>
            </label>
            <input
              type="text"
              value={formData.name}
              onChange={(e) => handleNameChange(e.target.value)}
              placeholder="Въведете име на категория"
              required
              className="w-full rounded border-[1.5px] border-stroke bg-transparent py-3 px-5 font-medium outline-none transition focus:border-primary active:border-primary disabled:cursor-default disabled:bg-whiter dark:border-form-strokedark dark:bg-form-input dark:focus:border-primary"
            />
          </div>

          <div className="mb-6">
            <label className="mb-2.5 block text-black dark:text-white">
              Slug <span className="text-meta-1">*</span>
            </label>
            <input
              type="text"
              value={formData.slug}
              onChange={(e) => setFormData({ ...formData, slug: e.target.value })}
              placeholder="category-slug"
              required
              className="w-full rounded border-[1.5px] border-stroke bg-transparent py-3 px-5 font-medium outline-none transition focus:border-primary active:border-primary disabled:cursor-default disabled:bg-whiter dark:border-form-strokedark dark:bg-form-input dark:focus:border-primary"
            />
            <p className="mt-1.5 text-sm text-gray-500 dark:text-gray-400">
              Slug се генерира автоматично от името, но може да се промени ръчно
            </p>
          </div>

          <div className="flex gap-3">
            <button
              type="submit"
              disabled={isSubmitting}
              className="flex justify-center rounded-lg bg-brand-500 py-3 px-6 font-medium text-white shadow-theme-xs hover:bg-brand-600 transition disabled:cursor-not-allowed disabled:opacity-50"
            >
              {isSubmitting ? 'Запазване...' : isEdit ? 'Обнови' : 'Създай категория'}
            </button>

            <Link
              href="/admin/categories"
              className="flex justify-center rounded border border-stroke py-3 px-6 font-medium text-black hover:shadow-1 dark:border-strokedark dark:text-white"
            >
              Отказ
            </Link>
          </div>
        </div>
      </form>
    </div>
  );
}
